package com.somewater.social {	import com.progrestar.common.util.JSON;import flash.events.Event;import flash.events.EventDispatcher;import flash.external.ExternalInterface;[Event(name="complete", type="flash.events.Event")]internal class MailruCall	{		static private var callbacks     : Object = {};	static private var flashId       : String;	static private var appPrivateKey : String;	static private var dispatcher    : EventDispatcher = new  EventDispatcher();	static public var isInited       : Boolean = false;	static private var isApiInited	 : Boolean = false;		// ссылка на ф-ю логирования ошибок api callback(request:String = null, response:Object = null, status:int = 200, args:Object = null):void	static public var logError:Function;		/**	 * хардкод, запоминаем параметры последнего запроса, осуществляющего постинг	 */	private static var lastCallback:CallbackInfo;	public static function createLastCallback(method:String, args:Object):void	{		lastCallback = new CallbackInfo(0, null, method, args); 	}		static public function init ( DOMFlashId : String, privateKey : String ) : void {		if ( isInited ) { throw Error ( 'MailruCall already initialized' ); return; }		flashId = DOMFlashId;		appPrivateKey = privateKey;		ExternalInterface.addCallback('mailruReceive', receiver);		exec ( 'mailru.init', onApiLoaded, privateKey, flashId );		isInited = true;	}			/** Если callback не указан, exec() попытается вернуть значение **/		static public function exec ( method : String, callback : Function = null, ...args ) : * {		lastCallback = null;		var cbid : int;		if ( callback != null ) {			cbid = Math.round ( Math.random() * int.MAX_VALUE );						callbacks[cbid] = new CallbackInfo(cbid, callback, method, args);		}		var objectName:String = (method.match(/(.*)\.[^.]+$/)||[0,'window'])[1];		return ExternalInterface.call('' +			'(function(args, cbid){ ' +  			'if(typeof ' + method + ' != "function"){ ' +			'	if(cbid) { document.getElementById("'+ flashId+ '").mailruReceive(cbid, ' + method + '); }' +			'	else { return '+ method+ '; }' +			'}' +  						'if(cbid) {' + 			'	args.unshift(function(value){ ' + 			'		document.getElementById("'+ flashId+ '").mailruReceive(cbid, value) ' +			'	}); ' + 			'};' + 			'return '+ method+ '.apply('+ objectName+ ', args) ' + 			'})', args, cbid);	}		static private function receiver ( cbid : Number, data : Object ) : void {		if ( callbacks[cbid] ) {			var cbInfo:CallbackInfo = callbacks[cbid];			var cb : Function = cbInfo.callback;			delete callbacks[cbid];						// TODO: распознать, что сервер ответил что то невалидное и обработать в сошл. адаптере как logError			// как узнать факт ошибки - хз, зависит от того, что ждет запрос			// Стандартного формата ошибок на данный момент не описано						cb.call ( null, data );		}	}		static private function eventReceiver ( name : String, data : Object ) : void {		trace("new Event name:" + name + ", data:" + JSON.encode(data));				if(data && data.hasOwnProperty("status") && String(data.status).search(/(error|fail)/i) != -1)		{			// обработать как ошибку api			if(lastCallback)			{				logError(JSON.encode(lastCallback.args), JSON.encode(data), 200, {"url":lastCallback.method});				lastCallback = null;			}else{				logError(null,JSON.encode(data));			}		}				dispatchEvent ( new MailruCallEvent ( name, data ) );	}			static private function onApiLoaded ( ...args ) : void {		isApiInited = true;		ExternalInterface.addCallback ( 'mailruEvent', eventReceiver );		dispatchEvent ( new Event ( Event.COMPLETE ) );	}		/************************* EventDispatcher IMPLEMENTATION ****************************/		static public function addEventListener ( type : String, listener : Function, priority : int = 0, useWeakReference : Boolean = false ) : void {   		dispatcher.addEventListener ( type, listener, false, priority, useWeakReference );	}		static public function removeEventListener ( type : String, listener : Function ) : void {		dispatcher.removeEventListener ( type, listener );	}		static public function hasEventListener ( type : String ) : Boolean {		return dispatcher.hasEventListener ( type );	}		static public function dispatchEvent ( event : Event ) : void {		dispatcher.dispatchEvent ( event );	}	}}class CallbackInfo{	public var cbid:int;	public var callback:Function;	public var method:String;	public var args:Object;		public function CallbackInfo(cbid:int, callback:Function, method:String, args:Object)	{		this.cbid = cbid;		this.callback = callback;		this.method = method;		this.args = args;	}}